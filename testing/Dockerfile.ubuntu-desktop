# ##############################################################################
# UBUNTU 22.04 DESKTOP TEST ENVIRONMENT
# Generated by DevUtils CLI (https://github.com/fredlackey/devutils-cli)
# ##############################################################################
#
# This image includes a full desktop environment for testing GUI applications
# like VS Code, Bambu Studio, Balena Etcher, etc.
#
# Usage:
#   docker compose up --build ubuntu-desktop
#   docker compose run --rm ubuntu-desktop bash
#
# ##############################################################################

FROM ubuntu:22.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install base dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    sudo \
    openssh-client \
    gnupg \
    wget \
    ca-certificates \
    software-properties-common \
    && rm -rf /var/lib/apt/lists/*

# Install minimal desktop environment and display server
# Using ubuntu-desktop-minimal for a lighter footprint while still providing
# full desktop functionality (GNOME shell, file manager, settings, etc.)
RUN apt-get update && apt-get install -y \
    ubuntu-desktop-minimal \
    xvfb \
    x11vnc \
    dbus-x11 \
    at-spi2-core \
    libgtk-3-0 \
    libnotify4 \
    libnss3 \
    libxss1 \
    libxtst6 \
    xdg-utils \
    libsecret-1-0 \
    libappindicator3-1 \
    libgbm1 \
    libasound2 \
    fonts-liberation \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20 LTS
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Create non-root test user (simulates real usage)
RUN useradd -m -s /bin/bash testuser \
    && echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Create working directories
RUN mkdir -p /app /home/testuser/.ssh /home/testuser/.local/share/applications \
    && chown -R testuser:testuser /home/testuser

# Set working directory
WORKDIR /app

# Copy package files first (for better layer caching)
COPY --chown=testuser:testuser package*.json ./

# Install dependencies as root (before switching user)
RUN npm install

# Copy source code
COPY --chown=testuser:testuser . .

# Create global link for the dev command
RUN npm link

# Switch to test user
USER testuser

# Configure git (required for testing)
RUN git config --global user.email "testuser@example.com" \
    && git config --global user.name "Test User" \
    && git config --global init.defaultBranch main

# Set environment variables
ENV HOME=/home/testuser
ENV PATH="/home/testuser/.local/bin:${PATH}"
ENV TEST_PLATFORM=ubuntu-desktop

# Display environment variables for Xvfb (virtual framebuffer)
# These allow GUI applications to run in headless mode
ENV DISPLAY=:99
ENV XVFB_SCREEN_SIZE=1920x1080x24

# XDG directories for proper desktop integration
ENV XDG_RUNTIME_DIR=/tmp/runtime-testuser
ENV XDG_CONFIG_HOME=/home/testuser/.config
ENV XDG_DATA_HOME=/home/testuser/.local/share
ENV XDG_CACHE_HOME=/home/testuser/.cache

# Default command
CMD ["/bin/bash"]
