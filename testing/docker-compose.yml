# ##############################################################################
# DOCKER COMPOSE - TEST ORCHESTRATION
# Generated by DevUtils CLI (https://github.com/fredlackey/devutils-cli)
# ##############################################################################
#
# Usage:
#   docker compose up --build              # Run all platforms
#   docker compose up --build ubuntu       # Run Ubuntu only
#   docker compose run --rm ubuntu bash    # Interactive shell
#
# ##############################################################################

services:
  ubuntu:
    platform: linux/amd64
    build:
      context: ..
      dockerfile: testing/Dockerfile.ubuntu
    volumes:
      - test-tmp-ubuntu:/tmp
    environment:
      - TEST_PLATFORM=ubuntu
    working_dir: /app
    command: ["/app/testing/scripts/run-tests.sh"]

  debian:
    platform: linux/amd64
    build:
      context: ..
      dockerfile: testing/Dockerfile.debian
    volumes:
      - test-tmp-debian:/tmp
    environment:
      - TEST_PLATFORM=debian
    working_dir: /app
    command: ["/app/testing/scripts/run-tests.sh"]

  amazonlinux:
    platform: linux/amd64
    build:
      context: ..
      dockerfile: testing/Dockerfile.amazonlinux
    volumes:
      - test-tmp-amazonlinux:/tmp
    environment:
      - TEST_PLATFORM=amazonlinux
    working_dir: /app
    command: ["/app/testing/scripts/run-tests.sh"]

  fedora:
    platform: linux/amd64
    build:
      context: ..
      dockerfile: testing/Dockerfile.fedora
    volumes:
      - test-tmp-fedora:/tmp
    environment:
      - TEST_PLATFORM=fedora
    working_dir: /app
    command: ["/app/testing/scripts/run-tests.sh"]

  ubuntu-desktop:
    platform: linux/amd64
    build:
      context: ..
      dockerfile: testing/Dockerfile.ubuntu-desktop
    volumes:
      - test-tmp-ubuntu-desktop:/tmp
    environment:
      - TEST_PLATFORM=ubuntu-desktop
      - DISPLAY=:99
      - XDG_RUNTIME_DIR=/tmp/runtime-testuser
    working_dir: /app
    # Start Xvfb virtual display before running tests
    command: ["/bin/bash", "-c", "mkdir -p /tmp/runtime-testuser && chmod 700 /tmp/runtime-testuser && Xvfb :99 -screen 0 1920x1080x24 & sleep 2 && /app/testing/scripts/run-tests.sh"]

volumes:
  test-tmp-ubuntu:
  test-tmp-debian:
  test-tmp-amazonlinux:
  test-tmp-fedora:
  test-tmp-ubuntu-desktop:
